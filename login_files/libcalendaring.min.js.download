function rcube_libcalendaring(e){if(this.settings=e||{},this.alarm_ids=[],this.alarm_dialog=null,this.snooze_popup=null,this.dismiss_link=null,this.group2expand={},e&&e.date_format){var t=this,a=(new Date).getTimezoneOffset()/-60-(e.timezone||0)-(e.dst||0),i=(new Date).getTimezoneOffset(),r={dateFormat:e.date_format.replace(/M/g,"m").replace(/mmmmm/,"MM").replace(/mmm/,"M").replace(/dddd/,"DD").replace(/ddd/,"D").replace(/yy/g,"y"),firstDay:e.first_day,dayNamesMin:e.days_short,monthNames:e.months,monthNamesShort:e.months,changeMonth:!1,showOtherMonths:!0,selectOtherMonths:!0},n=this.quote_html=function(e){return String(e).replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")};this.event_date_text=function(e,t){if(!e.start)return"";e.end||(e.end=e.start);var a,i=e.end.getTime()/1e3-e.start.getTime()/1e3,r=t?" "+rcmail.gettext("until","libcalendaring")+" ":" â€” ";return a=e.allDay?this.format_datetime(e.start,1,t)+(i>86400||e.start.getDay()!=e.end.getDay()?r+this.format_datetime(e.end,1,t):""):i<86400&&e.start.getDay()==e.end.getDay()?this.format_datetime(e.start,0,t)+(i>0?r+this.format_datetime(e.end,2,t):""):this.format_datetime(e.start,0,t)+(i>0?r+this.format_datetime(e.end,0,t):"")},this.has_attendees=function(t){return!!(t.attendees&&t.attendees.length&&(t.attendees.length>1||String(t.attendees[0].email).toLowerCase()!=e.identity.email))},this.is_attendee=function(t,a,i){var r,n=i?";"+i.toLowerCase():e.identity.emails;for(r=0;t.attendees&&r<t.attendees.length;r++)if((!a||t.attendees[r].role==a)&&t.attendees[r].email&&n.indexOf(";"+t.attendees[r].email.toLowerCase())>=0)return t.attendees[r];return!1},this.is_organizer=function(e,t){return this.is_attendee(e,"ORGANIZER",t)||!e.id},this.has_permission=function(e,t){if(String(t).length>1)for(var a=0;a<t.length;a++)if(this.has_permission(e,t[a]))return!0;return!!(e.rights&&String(e.rights).indexOf(t)>=0)||("i"==t&&e.editable||"v"==t&&e.editable)},this.parse_datetime=function(e,t){var t=t?$.datepicker.parseDate(r.dateFormat,t,r):new Date,a=e.replace(/\s*[ap][.m]*/i,"").replace(/0([0-9])/g,"$1").split(/[:.]/);return isNaN(a[0])||(t.setHours(a[0]),e.match(/p[.m]*/i)&&t.getHours()<12?t.setHours(parseInt(a[0])+12):e.match(/a[.m]*/i)&&12==t.getHours()&&t.setHours(0)),isNaN(a[1])||t.setMinutes(a[1]),t},this.parseISO8601=function(e){if(e&&e.getMonth)return e;var t=function(e,t){if(+e)for(;e.getDate()!=t.getDate();)e.setTime(+e+36e5*(e<t?1:-1))},a=e&&e.match(/^([0-9]{4})(-([0-9]{2})(-([0-9]{2})([T ]([0-9]{2}):([0-9]{2})(:([0-9]{2})(\.([0-9]+))?)?(Z|(([-+])([0-9]{2})(:?([0-9]{2}))?))?)?)?)?$/);if(!a)return null;var i=new Date(a[1],0,2),r=new Date(a[1],0,2,9,0);return a[3]&&(i.setMonth(a[3]-1),r.setMonth(a[3]-1)),a[5]&&(i.setDate(a[5]),r.setDate(a[5])),t(i,r),a[7]&&i.setHours(a[7]),a[8]&&i.setMinutes(a[8]),a[10]&&i.setSeconds(a[10]),a[12]&&i.setMilliseconds(1e3*Number("0."+a[12])),t(i,r),i},this.date2ISO8601=function(e){var t=function(e){return(e<10?"0":"")+e};return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+"T"+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())},this.format_datetime=function(e,t,a){var i="";return t&&1!=t||(i+=$.datepicker.formatDate(a?"MM d yy":r.dateFormat,e,r)),t||(i+=a?" "+rcmail.gettext("at","libcalendaring")+" ":" "),t&&2!=t||(i+=this.format_time(e,a)),i},this.format_time=function(t,a){var i,r,n,l,c=function(e){return(e<10?"0":"")+e},s={s:function(e){return e.getSeconds()},ss:function(e){return c(e.getSeconds())},m:function(e){return e.getMinutes()},mm:function(e){return c(e.getMinutes())},h:function(e){return e.getHours()%12||12},hh:function(e){return c(e.getHours()%12||12)},H:function(e){return e.getHours()},HH:function(e){return c(e.getHours())},t:function(e){return e.getHours()<12?"a":"p"},tt:function(e){return e.getHours()<12?"am":"pm"},T:function(e){return e.getHours()<12?"A":"P"},TT:function(e){return e.getHours()<12?"AM":"PM"}},d="",o=a?e.time_format.replace(":"," ").replace("HH","H").replace("hh","h").replace("mm","m").replace("ss","s"):e.time_format;for(i=0;i<o.length;i++){for(n=o.charAt(i),r=Math.min(i+2,o.length);r>i;r--)if(l=s[o.substring(i,r)]){d+=l(t),i=r-1;break}r==i&&(d+=n)}return d},this.date2unixtime=function(e){var t=60*(i-e.getTimezoneOffset());return Math.round(e.getTime()/1e3+3600*a+t)},this.fromunixtime=function(e){e-=3600*a;var t=new Date(1e3*e),r=60*(i-t.getTimezoneOffset());return r&&t.setTime(1e3*(e+3600)),t},this.text2html=function(e,t,a){var i=n(String(e));if(t){for(var r,l='<span>... <a href="#more" onclick="$(this).parent().hide().next().show();return false" class="morelink">'+rcmail.gettext("showmore","libcalendaring")+'</a></span><span style="display:none">',c=i.split(/\r?\n/),s="",d=0,o=0;o<c.length;o++)if(d+=c[o].length,a&&o==a-1)s+=c[o]+"\n"+l,t=2*i.length;else if(d>t){d=s.length,r=c[o].split(" ");for(var m=0;m<r.length;m++)d+=r[m].length+1,s+=r[m]+" ",d>t&&(s+=l,t=2*i.length,a=0);s+="\n"}else s+=c[o]+"\n";t>e.length&&(s+="</span>"),i=s}var u="[^?&@\"'/\\(\\)\\s\\r\\t\\n]+\\.([^\0-/;-@[-`{-]{2,}|xn--[a-z0-9]{2,})",p=".:;,",h="a-z0-9%=#@+?&/_~\\[\\]-",g=new RegExp("([hf]t+ps?://)("+u+"(["+p+"]?["+h+"]+)*)","ig"),f=new RegExp("([^\\s\\n\\(\\);]+@"+u+")","ig"),_=function(e,t,a){var i="",r=a;return a&&a.length>55&&(r=a.substr(0,45)+"..."+a.substr(-8),i=t+a),'<a href="'+t+a+'" class="extlink" target="_blank" title="'+i+'">'+t+r+"</a>"};return i.replace(g,_).replace(f,'<a href="mailto:$1">$1</a>').replace(/(mailto:)([^"]+)"/g,"$1$2\" onclick=\"rcmail.command('compose', '$2');return false\"").replace(/\n/g,"<br/>")},this.init_alarms_edit=function(e,a){var i=$(e+" select.edit-alarm-type"),n=i.attr("id");i.change(function(){$(this).parent().find("span.edit-alarm-values")[this.selectedIndex>0?"show":"hide"]()}),$(e+" select.edit-alarm-offset").change(function(){var e=$(this).val(),t=$(this).parent();t.find(".edit-alarm-date, .edit-alarm-time")["@"==e?"show":"hide"](),t.find(".edit-alarm-value").prop("disabled","@"===e||"0"===e),t.find(".edit-alarm-related")["@"==e?"hide":"show"]()}),$(e+" .edit-alarm-date").removeClass("hasDatepicker").removeAttr("id").datepicker(r),$(e).on("click","a.delete-alarm",function(e){return $(this).closest(".edit-alarm-item").siblings().length>0&&$(this).closest(".edit-alarm-item").remove(),!1}),(a||0)>0&&n&&(n+=":"+(new Date).getTime(),i.attr("id",n),$(e+" label:first").attr("for",n)),$(e).on("click","a.add-alarm",function(a){var i=$(this).closest(".edit-alarm-item").siblings().length+1,r=$(this).closest(".edit-alarm-item").clone(!1).removeClass("first").appendTo(e);return t.init_alarms_edit(e+" .edit-alarm-item:eq("+i+")",i),$("select.edit-alarm-type, select.edit-alarm-offset",r).change(),!1})},this.set_alarms_edit=function(e,t){$(e+" .edit-alarm-item:gt(0)").remove();var a,i,r,n,l;for(a=0;a<t.length;a++)if(i=t[a],i.action||(i.action="DISPLAY"),0==a?r=$(e+" .edit-alarm-item").eq(0):(r=$(e+" .edit-alarm-item").eq(0).clone(!1).removeClass("first").appendTo(e),this.init_alarms_edit(e+" .edit-alarm-item:eq("+a+")",a)),$("select.edit-alarm-type",r).val(i.action),$("select.edit-alarm-related",r).val(/END/i.test(i.related)?"end":"start"),String(i.trigger).match(/@(\d+)/)){var c=this.fromunixtime(parseInt(RegExp.$1));$("select.edit-alarm-offset",r).val("@"),$("input.edit-alarm-value",r).val(""),$("input.edit-alarm-date",r).val(this.format_datetime(c,1)),$("input.edit-alarm-time",r).val(this.format_datetime(c,2))}else String(i.trigger).match(/^[-+]*0[MHDS]$/)?($("input.edit-alarm-value",r).val("0"),$("select.edit-alarm-offset",r).val("0")):String(i.trigger).match(/([-+])(\d+)([MHDS])/)&&(n=RegExp.$2,l=""+RegExp.$1+RegExp.$3,$("input.edit-alarm-value",r).val(n),$("select.edit-alarm-offset",r).val(l));$(e+" select.edit-alarm-type, "+e+" select.edit-alarm-offset").change()},this.serialize_alarms=function(e){var a=[];return $(e+" .edit-alarm-item").each(function(e,i){var r,n,l={action:$("select.edit-alarm-type",i).val(),related:$("select.edit-alarm-related",i).val()};l.action&&(n=$("select.edit-alarm-offset",i).val(),"@"==n?l.trigger="@"+t.date2unixtime(t.parse_datetime($("input.edit-alarm-time",i).val(),$("input.edit-alarm-date",i).val())):"0"===n?l.trigger="0S":!isNaN(r=parseInt($("input.edit-alarm-value",i).val()))&&r>=0&&(l.trigger=n[0]+r+n[1]),a.push(l))}),a};var l=function(e,a,i){var r,n,l,c="",s=new Date;return s.setHours(e),s.setMinutes(a),r=t.format_time(s),i&&(n=Math.floor((s.getTime()-i.getTime())/6e4),n>0&&(l="m",n>=60&&(l="h",n=Math.round(n/3)/20),c=" ("+n+l+")")),[r,c]},c=function(e,a){var i,r,n=15,c=[],s=new Date,d=String(this.element.attr("id")),o=d.match(/^(.*)-(starttime|endtime)$/),m=o&&"endtime"==o[2]&&(i=$("#"+o[1]+"-starttime").val())&&$("#"+o[1]+"-startdate").val()==$("#"+o[1]+"-enddate").val()?t.parse_datetime(i,""):null,u=e.term-1>0||e.term.length>1,p=m?m.getHours():(u?t.parse_datetime(e.term,""):s).getHours(),h=60*p+(u?0:s.getMinutes()),g=Math.ceil(h/n)*n%60,f=Math.floor(Math.ceil(h/n)*n/60);for(r=m?m.getHours():0;r<p;r++)c.push(l(r,0,m));for(;r<f+2&&r<24;r++){for(;g<60;)c.push(l(r,g,m)),g+=n;g=0}for(;r<24;)c.push(l(r++,0,m));return a(c)},s=function(e,t){var a=$(this),i=a.autocomplete("widget");menu=a.data("ui-autocomplete").menu,amregex=/^(.+)(a[.m]*)/i,pmregex=/^(.+)(a[.m]*)/i,val=$(this).val().replace(amregex,"0:$1").replace(pmregex,"1:$1"),i.css("width","10em"),""===val?menu._scrollIntoView(i.children("li:first")):i.children().each(function(){var e=$(this),t=e.children().first().html().replace(/\s+\(.+\)$/,"").replace(amregex,"0:$1").replace(pmregex,"1:$1");0==t.indexOf(val)&&menu._scrollIntoView(e)})};this.init_time_autocomplete=function(e,t){var a={delay:100,minLength:1,appendTo:t.container,source:c,open:s,select:function(e,t){return $(this).val(t.item[0]).change(),!1}};$(e).attr("autocomplete","off").autocomplete($.extend(a,t)).click(function(){$(this).autocomplete("search",$(this).val()?$(this).val().replace(/\D.*/,""):" ")}),$(e).data("ui-autocomplete")._renderItem=function(e,t){return $("<li>").data("ui-autocomplete-item",t).append("<a>"+t[0]+t[1]+"</a>").appendTo(e)}},this.display_alarms=function(e){this.alarm_dialog&&this.alarm_dialog.dialog("destroy").remove();var a,i,r,l,c,s,d=[],o=[],m=[],u={};for(a=0;a<e.length;a++)c=e[a],c.start=this.parseISO8601(c.start),c.end=this.parseISO8601(c.end),"AUDIO"!=c.action?(m.push(c.id),s='<h3 class="event-title">'+n(c.title)+"</h3>",s+='<div class="event-section">'+n(c.location||"")+"</div>",s+='<div class="event-section">'+n(this.event_date_text(c))+"</div>",r=$('<a href="#" class="alarm-action-dismiss"></a>').html(rcmail.gettext("dismiss","libcalendaring")).click(function(e){t.dismiss_link=$(this),t.dismiss_alarm(t.dismiss_link.data("id"),0,e)}),l=$('<a href="#" class="alarm-action-snooze"></a>').html(rcmail.gettext("snooze","libcalendaring")).click(function(e){return t.snooze_dropdown($(this),e),e.stopPropagation(),!1}),i=$("<div>").addClass("alarm-actions").append(r.data("id",c.id)).append(l.data("id",c.id)),o.push($("<div>").addClass("alarm-item").html(s).append(i))):d.push(c);d.length&&this.audio_alarms(d),o.length&&(this.alarm_dialog=$("<div>").attr("id","alarm-display").append(o),u[rcmail.gettext("close")]=function(){$(this).dialog("close")},u[rcmail.gettext("dismissall","libcalendaring")]=function(e){t.dismiss_alarm(t.alarm_ids.join(","),0,e),$(this).dialog("close")},this.alarm_dialog.appendTo(document.body).dialog({modal:!1,resizable:!0,closeOnEscape:!1,dialogClass:"alarms",title:rcmail.gettext("alarmtitle","libcalendaring"),buttons:u,open:function(){setTimeout(function(){t.alarm_dialog.parent().find(".ui-button:not(.ui-dialog-titlebar-close)").first().focus()},5)},close:function(){$("#alarm-snooze-dropdown").hide(),$(this).dialog("destroy").remove(),t.alarm_dialog=null,t.alarm_ids=null},drag:function(e,t){$("#alarm-snooze-dropdown").hide()}}),this.alarm_dialog.closest("div[role=dialog]").attr("role","alertdialog"),this.alarm_ids=m)},this.audio_alarms=function(e){var t,a=[],i=rcmail.assets_path("plugins/libcalendaring/alarm"),r=navigator.mimeTypes?navigator.mimeTypes["audio/mp3"]:{};$.each(e,function(){a.push(this.title)}),rcmail.display_message(rcmail.gettext("alarmtitle","libcalendaring")+": "+n(a.join(", ")),"notice",1e4),i+=bw.ie||r&&r.enabledPlugin?".mp3":".wav";try{t=$("<audio>").attr("src",i),t.get(0).play()}catch(l){t=$('<embed id="libcalsound" src="'+i+'" hidden=true autostart=true loop=false />'),t.appendTo($("body")),window.setTimeout("$('#libcalsound').remove()",1e4)}},this.snooze_dropdown=function(e,a){this.snooze_popup||(this.snooze_popup=$("#alarm-snooze-dropdown"),this.snooze_popup.length||(this.snooze_popup=$("<div>").attr("id","alarm-snooze-dropdown").addClass("popupmenu").appendTo(document.body),this.snooze_popup.html(rcmail.env.snooze_select)),$("#alarm-snooze-dropdown a").click(function(e){var a=String(this.href).replace(/.+#/,"");return t.dismiss_alarm($("#alarm-snooze-dropdown").data("id"),a,e),!1})),this.snooze_popup.is(":visible")&&this.snooze_popup.data("id")==e.data("id")?(rcmail.command("menu-close","alarm-snooze-dropdown",e.get(0),a),this.dismiss_link=null):(rcmail.command("menu-open","alarm-snooze-dropdown",e.get(0),a),this.snooze_popup.data("id",e.data("id")),this.dismiss_link=e)},this.dismiss_alarm=function(e,t,a){if(rcmail.command("menu-close","alarm-snooze-dropdown",null,a),rcmail.http_post("utils/plugin.alarms",{action:"dismiss",data:{id:e,snooze:t}}),this.dismiss_link){this.dismiss_link.closest("div.alarm-item").hide();var i=jQuery.grep(this.alarm_ids,function(t){return t!=e});i.length?this.alarm_ids=i:this.alarm_dialog.dialog("close")}this.dismiss_link=null},this.init_recurrence_edit=function(e){$("#edit-recurrence-frequency").change(function(e){var t=$(this).val().toLowerCase();$(".recurrence-form").hide(),t&&($("#recurrence-form-"+t).show(),"rdate"!=t&&$("#recurrence-form-until").show())}),$("#recurrence-form-rdate input.button.add").click(function(e){var a,i=$("#edit-recurrence-rdate-input").val();i&&(a=t.parse_datetime("12:00",i))?(t.add_rdate(a),t.sort_rdates(),$("#edit-recurrence-rdate-input").val("")):$("#edit-recurrence-rdate-input").select()}),$("#edit-recurrence-rdates").on("click","a.delete",function(e){return $(this).closest("li").remove(),!1}),$("#edit-recurrence-enddate").datepicker(r).click(function(){$("#edit-recurrence-repeat-until").prop("checked",!0)}),$("#edit-recurrence-repeat-times").change(function(e){$("#edit-recurrence-repeat-count").prop("checked",!0)}),$("#edit-recurrence-rdate-input").datepicker(r)},this.set_recurrence_edit=function(e){$("#edit-recurrence-frequency").val(e.recurrence?e.recurrence.FREQ||(e.recurrence.RDATE?"RDATE":""):"").change(),$(".recurrence-form select.edit-recurrence-interval").val(e.recurrence?e.recurrence.INTERVAL||1:1),$("#edit-recurrence-repeat-times").val(e.recurrence?e.recurrence.COUNT||1:1),$("#edit-recurrence-enddate").val(e.recurrence&&e.recurrence.UNTIL?this.format_datetime(this.parseISO8601(e.recurrence.UNTIL),1):"");$(".recurrence-form input.edit-recurrence-until:checked").prop("checked",!1),$("#edit-recurrence-rdates").html("");var a=["SU","MO","TU","WE","TH","FR","SA"],i="#edit-recurrence-repeat-forever";if(e.recurrence&&e.recurrence.COUNT?i="#edit-recurrence-repeat-count":e.recurrence&&e.recurrence.UNTIL&&(i="#edit-recurrence-repeat-until"),$(i).prop("checked",!0),e.recurrence&&e.recurrence.BYDAY&&"WEEKLY"==e.recurrence.FREQ){var r=e.recurrence.BYDAY.split(",");$("input.edit-recurrence-weekly-byday").val(r)}if(e.recurrence&&e.recurrence.BYMONTHDAY&&($("input.edit-recurrence-monthly-bymonthday").val(String(e.recurrence.BYMONTHDAY).split(",")),$("input.edit-recurrence-monthly-mode").val(["BYMONTHDAY"])),e.recurrence&&e.recurrence.BYDAY&&("MONTHLY"==e.recurrence.FREQ||"YEARLY"==e.recurrence.FREQ)){var n,l=e.recurrence.FREQ.toLowerCase();(n=String(e.recurrence.BYDAY).match(/(-?[1-4])([A-Z]+)/))&&($("#edit-recurrence-"+l+"-prefix").val(n[1]),$("#edit-recurrence-"+l+"-byday").val(n[2])),$("input.edit-recurrence-"+l+"-mode").val(["BYDAY"])}else e.start&&$("#edit-recurrence-monthly-byday").val(a[e.start.getDay()]);e.recurrence&&e.recurrence.BYMONTH?$("input.edit-recurrence-yearly-bymonth").val(String(e.recurrence.BYMONTH).split(",")):e.start&&$("input.edit-recurrence-yearly-bymonth").val([String(e.start.getMonth()+1)]),e.recurrence&&e.recurrence.RDATE&&$.each(e.recurrence.RDATE,function(e,a){t.add_rdate(t.parseISO8601(a))})},this.serialize_recurrence=function(e){var a="",i=$("#edit-recurrence-frequency").val();if(""!=i){a={FREQ:i,INTERVAL:$("#edit-recurrence-interval-"+i.toLowerCase()).val()};var r=$("input.edit-recurrence-until:checked").val();if("count"==r?a.COUNT=$("#edit-recurrence-repeat-times").val():"until"==r&&(a.UNTIL=t.date2ISO8601(t.parse_datetime(e||"00:00",$("#edit-recurrence-enddate").val()))),"WEEKLY"==i){var n=[];$("input.edit-recurrence-weekly-byday:checked").each(function(){n.push(this.value)}),n.length&&(a.BYDAY=n.join(","))}else if("MONTHLY"==i){var l=$("input.edit-recurrence-monthly-mode:checked").val(),c=[];"BYMONTHDAY"==l?($("input.edit-recurrence-monthly-bymonthday:checked").each(function(){c.push(this.value)}),c.length&&(a.BYMONTHDAY=c.join(","))):a.BYDAY=$("#edit-recurrence-monthly-prefix").val()+$("#edit-recurrence-monthly-byday").val()}else if("YEARLY"==i){var n,s=[];$("input.edit-recurrence-yearly-bymonth:checked").each(function(){s.push(this.value)}),s.length&&(a.BYMONTH=s.join(",")),(n=$("#edit-recurrence-yearly-byday").val())&&(a.BYDAY=$("#edit-recurrence-yearly-prefix").val()+n)}else"RDATE"==i&&(a={RDATE:[]},""!=$("#edit-recurrence-rdate-input").val()&&$("#recurrence-form-rdate input.button.add").click(),$("#edit-recurrence-rdates li").each(function(e,t){a.RDATE.push($(t).attr("data-value"))}))}return a},this.add_rdate=function(e){var t=$("<li>").attr("data-value",this.date2ISO8601(e)).html("<span>"+n(this.format_datetime(e,1))+"</span>").appendTo("#edit-recurrence-rdates");$("<a>").attr("href","#del").addClass("iconbutton delete").html(rcmail.get_label("delete","libcalendaring")).attr("title",rcmail.get_label("delete","libcalendaring")).appendTo(t)},this.sort_rdates=function(){var e=$("#edit-recurrence-rdates"),t=e.children("li").get();t.sort(function(e,t){var a=$(e).attr("data-value"),i=$(t).attr("data-value");return a<i?-1:a>i?1:0}),$.each(t,function(t,a){e.append(a)})},this.expand_attendee_group=function(e,a,i){var r=(e.data?e.data.email:null)||$(e.target).attr("data-email"),n=$(e.target).closest("tr").find("select.edit-attendee-role option:selected");this.group2expand[r]={link:e.target,data:$.extend({},e.data||{}),adder:a,remover:i},n.length&&(this.group2expand[r].data.role=n.val()),this._expand_attendee_listener||(this._expand_attendee_listener=this.expand_attendee_callback,rcmail.addEventListener("plugin.expand_attendee_callback",function(e){t._expand_attendee_listener(e)})),rcmail.http_post("libcal/plugin.expand_attendee_group",{id:r,data:e.data||{}},rcmail.set_busy(!0,"loading"))},this.expand_attendee_callback=function(e){var t,a=e.id,i=this.group2expand[a],r=$(i.link).closest("tr");if(i&&i.adder&&e.members&&e.members.length){for(var n=0;n<e.members.length;n++)t=e.members[n],t.role=i.data.role,t.cutype="INDIVIDUAL",t.status="NEEDS-ACTION",i.adder(t,null,r);i.remover?i.remover(i.link,a):r.remove(),delete this.group2expand[a]}else rcmail.display_message(e.error||rcmail.gettext("expandattendeegroupnodata","libcalendaring"),"error")},this.render_message_links=function(e,t,a,i){var r=$("<ul>").addClass("attachmentslist");$.each(e,function(e,t){if(!t.mailurl)return!0;var n=$("<li>").addClass("link").addClass("message eml").append($("<a>").attr("href",t.mailurl).addClass("messagelink").text(t.subject||t.uri)).appendTo(r);a&&$("<a>").attr("href","#delete").attr("title",rcmail.gettext("removelink",i)).attr("data-uri",t.uri).addClass("delete").text(rcmail.gettext("delete")).appendTo(n)}),t.empty().append(r)},this.dialog_resize=function(e,t,a){var i=$(window),r=i.width(),n=i.height();$(e).dialog("option",{height:Math.min(n-20,t+130),width:Math.min(r-20,a+50)})}}}rcube_libcalendaring.attendee_html=function(e){var t,a="",i="libcalendaring",r=e.name||e.email,n="ORGANIZER"==e.role?"ORGANIZER":e.status;return n&&(n=n.toLowerCase()),e.email?(a=e.email,t=$("<a>").attr({href:"mailto:"+e.email,"class":"mailtolink","data-cutype":e.cutype}),n&&(a+=" ("+rcmail.gettext("status"+n,i)+")")):t=$("<span>"),e["delegated-to"]?a=rcmail.gettext("libcalendaring.delegatedto")+" "+e["delegated-to"]:e["delegated-from"]&&(a=rcmail.gettext("libcalendaring.delegatedfrom")+" "+e["delegated-from"]),$("<span>").append($("<span>").attr({"class":"attendee "+n,title:a}).append(t.text(r))).html()},rcube_libcalendaring.add_from_itip_mail=function(e,t,a,i){var r=!1;if(rcmail.env.rsvp_saved&&"declined"==a&&(r=confirm(rcmail.gettext("itip.declinedeleteconfirm"))),"delegated"==a)return rcube_libcalendaring.itip_delegate_dialog(function(a){rcmail.http_post(t+"/itip-delegate",{_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_part:e,_to:a.to,_rsvp:a.rsvp?1:0,_comment:a.comment,_folder:a.target},rcmail.set_busy(!0,"itip.savingdata"))},$("#rsvp-"+i+" .folder-select")),!1;var n=0,l="";return i&&(n=$("#noreply-"+i+":checked").length?1:0,n||(l=$("#reply-comment-"+i).val())),rcmail.http_post(t+"/mailimportitip",{_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_part:e,_folder:$("#itip-saveto").val(),_status:a,_del:r?1:0,_noreply:n,_comment:l},rcmail.set_busy(!0,"itip.savingdata")),!1},rcube_libcalendaring.itip_delegate_dialog=function(e,t){var a,i='<form class="itip-dialog-form" action="javascript:void()"><div class="form-section"><label for="itip-delegate-to">'+rcmail.gettext("itip.delegateto")+'</label><br/><input type="text" id="itip-delegate-to" class="text" size="40" value="" /></div><div class="form-section"><label for="itip-delegate-rsvp"><input type="checkbox" id="itip-delegate-rsvp" class="checkbox" size="40" value="" />'+rcmail.gettext("itip.delegatersvpme")+'</label></div><div class="form-section"><textarea id="itip-delegate-comment" class="itip-comment" cols="40" rows="8" placeholder="'+rcmail.gettext("itip.itipcomment")+'"></textarea></div><div class="form-section">'+(t&&t.length?t.html():"")+"</div></form>",r=[];return r.push({text:rcmail.gettext("itipdelegated","itip"),click:function(){var t=window.parent.document,i=String($("#itip-delegate-to",t).val()).replace(/(^\s+)|(\s+$)/,"");""!=i&&rcube_check_email(i,!0)?(e({to:i,rsvp:$("#itip-delegate-rsvp",t).prop("checked"),comment:$("#itip-delegate-comment",t).val(),target:$("#itip-saveto",t).val()}),setTimeout(function(){a.dialog("close")},500)):(alert(rcmail.gettext("itip.delegateinvalidaddress")),$("#itip-delegate-to",t).focus())}}),r.push({text:rcmail.gettext("cancel","itip"),click:function(){a.dialog("close")}}),a=rcmail.show_popup_dialog(i,rcmail.gettext("delegateinvitation","itip"),r,{width:460,open:function(e,t){$(this).parent().find(".ui-button:not(.ui-dialog-titlebar-close)").first().addClass("mainaction"),$(this).find("#itip-saveto").val("");var a,i=rcmail.is_framed()?parent.rcmail:rcmail;rcmail.env.autocomplete_threads>0&&(a={threads:rcmail.env.autocomplete_threads,sources:rcmail.env.autocomplete_sources}),i.init_address_input_events($(this).find("#itip-delegate-to").focus(),a),i.env.recipients_delimiter=""},close:function(e,t){rcm=rcmail.is_framed()?parent.rcmail:rcmail,rcm.ksearch_blur(),$(this).remove()}})},rcube_libcalendaring.itip_rsvp_recurring=function(e,t){var a=$("<ul></ul>").addClass("popupmenu libcal-rsvp-replymode");$.each(["all","current"],function(e,t){$("<li><a>"+rcmail.get_label("rsvpmode"+t,"libcalendaring")+"</a>").addClass("ui-menu-item").attr("rel",t).appendTo(a)});var i=e.attr("rel");a.menu({select:function(e,a){t(i,a.item.attr("rel"))}}).appendTo(document.body).position({my:"left top",at:"left bottom+2",of:e}).data("action",i),setTimeout(function(){$(document).one("click",function(){a.menu("destroy"),a.remove()})},100)},rcube_libcalendaring.remove_from_itip=function(e,t,a){confirm(rcmail.gettext("itip.deleteobjectconfirm").replace("$title",a))&&rcmail.http_post(t+"/itip-remove",e,rcmail.set_busy(!0,"itip.savingdata"))},rcube_libcalendaring.decline_attendee_reply=function(e,t){var a,i='<div class="itip-dialog-confirm-text">'+rcmail.gettext("itip.declineattendeeconfirm")+'</div><textarea id="itip-decline-comment" class="itip-comment" cols="40" rows="8"></textarea>',r=[];return r.push({text:rcmail.gettext("declineattendee","itip"),click:function(){rcmail.http_post(t+"/itip-decline-reply",{_uid:rcmail.env.uid,_mbox:rcmail.env.mailbox,_part:e,_comment:$("#itip-decline-comment",window.parent.document).val()},rcmail.set_busy(!0,"itip.savingdata")),a.dialog("close")}}),r.push({text:rcmail.gettext("cancel","itip"),click:function(){a.dialog("close")}}),a=rcmail.show_popup_dialog(i,rcmail.gettext("declineattendee","itip"),r,{width:460,open:function(){$(this).parent().find(".ui-button:not(.ui-dialog-titlebar-close)").first().addClass("mainaction"),$("#itip-decline-comment").focus()}}),!1},rcube_libcalendaring.fetch_itip_object_status=function(e){e.mbox=rcmail.env.mailbox,e.message_uid=rcmail.env.uid,rcmail.http_post(e.task+"/itip-status",{data:e})},rcube_libcalendaring.update_itip_object_status=function(e){if(rcmail.env.rsvp_saved=e.saved,rcmail.env.itip_existing=e.existing,$("#itip-buttons-"+e.id+" > div").hide(),$("#rsvp-"+e.id+" .folder-select").remove(),e.html&&($("#loading-"+e.id).next(".rsvp-status").remove(),$("#loading-"+e.id).hide().after(e.html)),"rsvp"==e.action&&$("#rsvp-"+e.id+" input.button").prop("disabled",!1).filter("."+String(e.status||"unknown").toLowerCase()).prop("disabled",e.latest),$("#"+e.action+"-"+e.id).show().find("input.button").last().after(e.select),e.rescheduled&&$(".calendar-eventdetails td.date").addClass("modified"),e.append&&e.append.selector){var t=$(e.append.selector);e.append.replacements?$.each(e.append.replacements,function(e,a){t.html(t.html().replace(e,a))}):e.append.html&&t.html(e.append.html),t.show()}},rcube_libcalendaring.itip_message_processed=function(e){e.after_action?setTimeout(function(){rcube_libcalendaring.itip_after_action(e.after_action)},1200):rcube_libcalendaring.fetch_itip_object_status(e)},rcube_libcalendaring.itip_after_action=function(e){if(e){var t=rcmail.is_framed()?parent.rcmail:rcmail;2===e?t.permanently_remove_messages():3===e?t.mark_message("delete"):t.move_messages(1===e?t.env.trash_mailbox:e)}},rcube_libcalendaring.open_itip_preview=function(e,t){rcmail.env.itip_existing||(e+="&itip="+escape(t));rcmail.open_window(e)},function(e){e.fn.serializeJSON=function(){var t={};return jQuery.map(e(this).serializeArray(),function(e,a){t[e.name]=e.value}),t}}(jQuery),window.rcmail&&rcmail.addEventListener("init",function(e){if(rcmail.env.libcal_settings){var t=new rcube_libcalendaring(rcmail.env.libcal_settings);rcmail.addEventListener("plugin.display_alarms",function(e){t.display_alarms(e)})}rcmail.addEventListener("plugin.update_itip_object_status",rcube_libcalendaring.update_itip_object_status).addEventListener("plugin.fetch_itip_object_status",rcube_libcalendaring.fetch_itip_object_status).addEventListener("plugin.itip_message_processed",rcube_libcalendaring.itip_message_processed),"get-attachment"==rcmail.env.action&&rcmail.gui_objects.attachmentframe&&rcmail.register_command("print-attachment",function(){var e=rcmail.get_frame_window(rcmail.gui_objects.attachmentframe.id);e&&e.print()},!0),"get-attachment"==rcmail.env.action&&rcmail.env.attachment_download_url&&rcmail.register_command("download-attachment",function(){rcmail.location_href(rcmail.env.attachment_download_url,window)},!0)});